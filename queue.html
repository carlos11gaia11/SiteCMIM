<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CMIM Queue</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
body{min-height:100vh;background:#f4f6f8;display:flex;flex-direction:column}
.navbar{background:#111;color:#fff;padding:16px 32px;display:flex;justify-content:space-between;align-items:center}
.user-info{font-size:13px;color:#ddd}
.main{flex:1;display:flex;justify-content:center;align-items:center;padding:40px}
.queue-container{width:100%;max-width:900px;background:#fff;border-radius:16px;padding:32px;box-shadow:0 10px 30px rgba(0,0,0,.08);position:relative}
.queue-container::before{content:"";position:absolute;inset:0;background:url('cmim.png') center/contain no-repeat;opacity:.05}
.queue-header{display:flex;justify-content:space-between;margin-bottom:24px;position:relative}
.badge{padding:6px 14px;border-radius:999px;font-size:13px;font-weight:600}
.md{background:#eef2ff;color:#4338ca}
.open{background:#e6f9f0;color:#0f9d58}
.lanes{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
.lane{background:#f9fafb;border-radius:12px;padding:12px;border:1px solid #e5e7eb}
.lane h3{text-align:center;font-size:14px;margin-bottom:8px}
.slot{background:#fff;border-radius:8px;padding:6px 8px;font-size:13px;margin-bottom:6px;border:1px dashed #d1d5db;display:flex;justify-content:space-between}
.slot button{background:none;border:none;cursor:pointer}
.overflow h3{font-size:14px;margin-bottom:8px;color:#b45309}
.overflow-list{background:#fffbeb;border:1px solid #fde68a;border-radius:12px;padding:12px;font-size:13px}
.form{display:grid;grid-template-columns:1fr auto;gap:12px;margin-top:20px}
.form select,.form button{padding:10px;border-radius:8px;border:1px solid #d1d5db}
.form button{background:#111;color:#fff;font-weight:600;cursor:pointer}
footer{background:#111;color:#aaa;text-align:center;padding:12px;font-size:12px}

  .queue-container::before{
  content:"";
  position:absolute;
  inset:0;
  background:url('cmim.png') center/contain no-repeat;
  opacity:.05;
  pointer-events: none; /* üî• ISSO RESOLVE */
}
</style>
</head>

<body>

<div class="navbar">
  <h1>CMIM Queue</h1>
  <div class="user-info" id="userInfo">Carregando...</div>
</div>

<div class="main">
<div class="queue-container">

<div class="queue-header">
  <div>
    <span class="badge md" id="mdBadge">MD3</span>
    <span class="badge open">Fila Aberta</span>
  </div>
  <div id="queueTime"></div>
</div>

<div class="lanes">
  <div class="lane"><h3>TOP</h3><div class="slot"></div><div class="slot"></div></div>
  <div class="lane"><h3>JG</h3><div class="slot"></div><div class="slot"></div></div>
  <div class="lane"><h3>MID</h3><div class="slot"></div><div class="slot"></div></div>
  <div class="lane"><h3>ADC</h3><div class="slot"></div><div class="slot"></div></div>
  <div class="lane"><h3>SUP</h3><div class="slot"></div><div class="slot"></div></div>
</div>

<div class="overflow">
  <h3>ü¶Å Le√£o de Vaga</h3>
  <div class="overflow-list" id="overflowList">Nenhum jogador</div>
</div>

<form class="form" onsubmit="event.preventDefault(); entrarFila();">
  <select id="laneSelect" required>
    <option value="">Escolha a lane</option>
    <option value="top">Top</option>
    <option value="jg">JG</option>
    <option value="mid">Mid</option>
    <option value="adc">ADC</option>
    <option value="sup">Sup</option>
  </select>
  <button>Entrar na fila</button>
</form>

</div>
</div>

<footer>CMIM ‚Ä¢ Campeonato Mais Insalubre do Mundo</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
 apiKey: "AIzaSyCM1zA9NYpxG9WSb8E4k91FNp2DIvqzPEQ",
 authDomain: "login-cmim.firebaseapp.com",
 projectId: "login-cmim",
 storageBucket: "login-cmim.firebasestorage.app",
 messagingSenderId: "1003784143194",
 appId: "1:1003784143194:web:4e059a0f7f592eb3b0b363"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser, profile;

function getQueueId(){
 const h=new Date().getHours();
 if(h<17) return "queue_14";
 if(h<20) return "queue_17";
 if(h<23) return "queue_20";
 return "queue_23";
}

const queueRef = ()=>doc(db,"queues",getQueueId());

onAuthStateChanged(auth,async user=>{
 if(!user){location.href="login.html";return}
 currentUser=user;
 const snap=await getDoc(doc(db,"users",user.uid));
 profile=snap.data();
 document.getElementById("userInfo").innerText=`Logado como ${profile.lolNick}`;
 initQueue();
 onSnapshot(queueRef(),s=>render(s.data()));
});

async function initQueue(){
 const snap=await getDoc(queueRef());
 if(!snap.exists()){
  await setDoc(queueRef(),{
   config:{md:"MD3"},
   lanes:{top:[],jg:[],mid:[],adc:[],sup:[]},
   overflow:[]
  });
 }
}

function render(data){
 const lanes=["top","jg","mid","adc","sup"];
 lanes.forEach((l,i)=>{
  const slots=document.querySelectorAll(".lane")[i].querySelectorAll(".slot");
  slots.forEach((s,idx)=>{
   const p=data.lanes[l][idx];
   if(p){
    s.innerHTML=`${p.nick}`+(p.uid===currentUser.uid?` <button onclick="sairFila()">‚ùå</button>`:"");
   }else s.innerText="Vaga";
  });
 });
 document.getElementById("overflowList").innerHTML=data.overflow.length
 ?data.overflow.map((p,i)=>`${i+1}. ${p.nick}`).join("<br>")
 :"Nenhum jogador";
}

window.entrarFila=async()=>{
 const lane=document.getElementById("laneSelect").value;
 const snap=await getDoc(queueRef());
 const d=snap.data();

 if(Object.values(d.lanes).flat().some(p=>p.uid===currentUser.uid))return;
 if(d.overflow.some(p=>p.uid===currentUser.uid))return;

 const player={uid:currentUser.uid,nick:profile.lolNick};

 if(d.lanes[lane].length<2)d.lanes[lane].push(player);
 else d.overflow.push(player);

 await updateDoc(queueRef(),{lanes:d.lanes,overflow:d.overflow});
};

window.sairFila=async()=>{
 const snap=await getDoc(queueRef());
 const d=snap.data();
 let saiuLane=null;

 for(const l in d.lanes){
  const i=d.lanes[l].findIndex(p=>p.uid===currentUser.uid);
  if(i!==-1){d.lanes[l].splice(i,1);saiuLane=l;}
 }
 d.overflow=d.overflow.filter(p=>p.uid!==currentUser.uid);
 if(saiuLane&&d.overflow.length)d.lanes[saiuLane].push(d.overflow.shift());
 await updateDoc(queueRef(),{lanes:d.lanes,overflow:d.overflow});
};
</script>

</body>
</html>

