<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CMIM - Login</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: url('cmim.png') no-repeat center center / cover;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      backdrop-filter: brightness(0.3);
    }

    .container {
      background: rgba(0, 0, 0, 0.8);
      padding: 40px;
      border-radius: 12px;
      width: 360px;
      color: yellow;
      box-shadow: 0 0 20px rgba(255, 255, 0, 0.3);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #FFD700;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: yellow;
      color: black;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
    }

    .switch {
      margin-top: 15px;
      text-align: center;
      cursor: pointer;
      color: #FFD700;
      font-size: 14px;
    }
  </style>
</head>

<body>

<div class="container">
  <h2 id="formTitle">Login CMIM</h2>

  <input type="email" id="email" placeholder="Seu Email" />

  <!-- CADASTRO -->
  <input type="text" id="lolNick" placeholder="Nick do LoL (ex: 11gaia11#000)" style="display:none">

  <select id="jaInsalubre" style="display:none" onchange="toggleInsalubre()">
    <option value="">VocÃª jÃ¡ faz parte do In House CMIM?</option>
    <option value="sim">Sim</option>
    <option value="nao">NÃ£o</option>
  </select>

  <select id="tierManual" style="display:none">
    <option value="">Seu Tier</option>
    <option value="S+">S+</option>
    <option value="S">S</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="D">D</option>
    <option value="E">E</option>
    <option value="F">F</option>
  </select>

  <select id="elo" style="display:none">
    <option value="">Elo Atual</option>
    <option>Desafiante</option>
    <option>GrÃ£o Mestre</option>
    <option>Mestre</option>
    <option>Diamante</option>
    <option>Esmeralda</option>
    <option>Platina</option>
    <option>Ouro</option>
    <option>Prata</option>
    <option>Bronze</option>
    <option>Ferro</option>
  </select>

  <select id="mainLane" style="display:none">
    <option value="">Main Lane</option>
    <option>TOP</option>
    <option>JUNGLE</option>
    <option>MID</option>
    <option>ADC</option>
    <option>SUPPORT</option>
  </select>

  <select id="secondaryLane" style="display:none">
    <option value="">Lane SecundÃ¡ria</option>
    <option>TOP</option>
    <option>JUNGLE</option>
    <option>MID</option>
    <option>ADC</option>
    <option>SUPPORT</option>
  </select>

  <input type="password" id="senha" placeholder="Senha" />
  <input type="password" id="confirmarSenha" placeholder="Confirmar Senha" style="display:none">

  <button onclick="handleAuth()" id="actionBtn">Entrar</button>

  <div class="switch" onclick="toggleForm()" id="switchText">
    NÃ£o tem conta? Cadastre-se.
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCM1zA9NYpxG9WSb8E4k91FNp2DIvqzPEQ",
  authDomain: "login-cmim.firebaseapp.com",
  projectId: "login-cmim"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let isRegister = false;

const $ = id => document.getElementById(id);

window.toggleForm = () => {
  isRegister = !isRegister;

  $("formTitle").innerText = isRegister ? "Cadastrar Conta" : "Login CMIM";
  $("actionBtn").innerText = isRegister ? "Cadastrar" : "Entrar";
  $("switchText").innerText = isRegister
    ? "JÃ¡ tem conta? FaÃ§a login."
    : "NÃ£o tem conta? Cadastre-se.";

  ["lolNick","jaInsalubre","mainLane","secondaryLane","confirmarSenha"]
    .forEach(id => $(id).style.display = isRegister ? "block" : "none");

  $("elo").style.display = "none";
  $("tierManual").style.display = "none";
};

window.toggleInsalubre = () => {
  const v = $("jaInsalubre").value;
  $("tierManual").style.display = v === "sim" ? "block" : "none";
  $("elo").style.display = v === "nao" ? "block" : "none";
};

function calcularTier(elo){
  return {
    Desafiante:"S+",
    "GrÃ£o Mestre":"S",
    Mestre:"A",
    Diamante:"B",
    Esmeralda:"C",
    Platina:"D",
    Ouro:"E"
  }[elo] || "F";
}

window.handleAuth = async () => {
  const email = $("email").value.trim();
  const senha = $("senha").value;
  const confirmarSenha = $("confirmarSenha").value;
  const lolNick = $("lolNick").value.trim();
  const jaInsalubre = $("jaInsalubre").value;
  const tierManual = $("tierManual").value;
  const elo = $("elo").value;
  const mainLane = $("mainLane").value;
  const secondaryLane = $("secondaryLane").value;

  if (!email || !senha) {
    alert("Preencha email e senha");
    return;
  }

  // ================= CADASTRO =================
  if (isRegister) {

    if (!lolNick || !jaInsalubre || !mainLane || !secondaryLane) {
      alert("Preencha todos os campos do cadastro");
      return;
    }

    if (senha !== confirmarSenha) {
      alert("As senhas nÃ£o coincidem");
      return;
    }

    const tier =
      jaInsalubre === "sim"
        ? tierManual
        : calcularTier(elo);

    if (!tier) {
      alert("Informe seu tier ou elo corretamente");
      return;
    }

    const tipo = ["S+","S","A"].includes(tier)
      ? "InsalubrÃ£o"
      : "Insalubrinho";

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, senha);
      const uid = cred.user.uid;

      await setDoc(doc(db,"users",uid),{
        email,
        lolNick,
        elo: elo || null,
        tier,
        tipo,
        mainLane,
        secondaryLane,
        role:"user",
        criadoEm:new Date()
      });

      alert(`âœ… Conta criada!\nðŸ”¥ VocÃª Ã© do ${tipo}`);
      await signOut(auth);
      toggleForm();

    } catch (e) {
      alert("Erro no cadastro: " + e.message);
    }

    return;
  }

  // ================= LOGIN =================
  try {
    const cred = await signInWithEmailAndPassword(auth, email, senha);
    const snap = await getDoc(doc(db,"users",cred.user.uid));
    location.href = snap.data().role === "admin"
      ? "ADMtabela.html"
      : "menu.html";
  } catch (e) {
    alert("Erro no login: " + e.message);
  }
};
</script>

</body>
</html>

